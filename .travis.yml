---
sudo: required

services:
  - docker

env:
  DOCKER_COMPOSE_VERSION: 1.6.0
  DOCKER_COMPOSE_CALL_PATH: 'docker-compose --file tests/docker-compose.yml'
  SITE: test.yml

before_install:
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin

install:
  - pip install ansible
  - "{ echo '[defaults]'; echo 'roles_path = ../'; } >> ansible.cfg"

before_script:
  - '${DOCKER_COMPOSE_CALL_PATH} up -d'
  # wait for mysql service to become available
  - 'while ! echo exit | nc localhost 43306; do sleep 2; done'

script:
  - 'container_id=$( ${DOCKER_COMPOSE_CALL_PATH} ps -q | sed -n 2p )'

  # Ansible syntax check.
  - 'sudo docker exec --tty ${container_id} env TERM=xterm ansible-playbook /etc/ansible/roles/role_under_test/tests/${SITE} --syntax-check'

  # Test role.
  - 'sudo docker exec --tty ${container_id} env TERM=xterm ansible-playbook /etc/ansible/roles/role_under_test/tests/${SITE}'

  # Test role idempotence.
  - 'sudo docker exec --tty ${container_id} env TERM=xterm ansible-playbook /etc/ansible/roles/role_under_test/tests/${SITE}'

  # Clean up
  - ' ${DOCKER_COMPOSE_CALL_PATH} stop"'

  - ' ${DOCKER_COMPOSE_CALL_PATH} rm -f"'

notifications:
  webhooks: https://galaxy.ansible.com/api/v1/notifications/
