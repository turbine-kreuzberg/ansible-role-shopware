---
- hosts: localhost

  vars:
    playbook: test.yml
    docker_compose_path: 'docker-compose --file tests/docker-compose.yml'

  pre_tasks:

    # Create ansible.cfg with correct roles_path
    - shell: printf '[defaults]\nroles_path=../ \ncallback_plugins=tests/callbacks' >ansible.cfg

    - name: start up docker compose
      command: "{{ docker_compose_path }} up -d"

    - name: wait for mysql-service to become available
      wait_for: port=43306 delay=5

    - name: get the container id
      command: "{{ docker_compose_path }} ps -q"
      register: container_id_list

    - name: playbook syntax check
      command: "docker exec --tty {{ container_id_list.stdout_lines.1 }} env TERM=xterm ansible-playbook /etc/ansible/roles/role_under_test/tests/{{ playbook }} --syntax-check"
      ignore_errors: yes

    - name: run playbook
      command: "docker exec --tty {{ container_id_list.stdout_lines.1 }} env TERM=xterm ansible-playbook /etc/ansible/roles/role_under_test/tests/{{ playbook }}"
      ignore_errors: yes

    - name: run playbook second time (idempotentency check)
      command: "docker exec --tty {{ container_id_list.stdout_lines.1 }} env TERM=xterm ansible-playbook /etc/ansible/roles/role_under_test/tests/{{ playbook }}"
      ignore_errors: yes

    - name: stop container
      command: "{{ docker_compose_path }} stop"

    - name: rm container
      command: "{{ docker_compose_path }} rm -f"
